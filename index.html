<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ColdChain ‚Äî Frozen Warehouse Inventory</title>
<meta name="description" content="Frozen warehouse inventory management system">
<meta name="theme-color" content="#0a0e14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ColdChain">
<!-- Manifest and apple-touch-icon injected by JS only when served over HTTP -->
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" onerror="this.remove()">
<style>
  :root {
    --bg: #0a0e14;
    --surface: #111722;
    --surface2: #171f2e;
    --border: #1e2d42;
    --border2: #2a3d57;
    --accent: #00c4ff;
    --accent2: #0088cc;
    --cold: #7dd3fc;
    --warn: #f59e0b;
    --danger: #ef4444;
    --success: #22c55e;
    --text: #e2e8f0;
    --text2: #8ba3bf;
    --text3: #4a6580;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Frost texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.025'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* Header */
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,14,20,0.95);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem;
    display: flex; align-items: center; justify-content: space-between;
    height: 60px;
  }

  .logo {
    font-family: var(--mono);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.1em;
    display: flex; align-items: center; gap: 0.6rem;
  }
  .logo-icon { font-size: 1.3rem; }

  .header-meta {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text3);
    text-align: right;
  }
  .header-meta span { color: var(--cold); }

  /* Layout */
  .app {
    position: relative; z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem 2rem;
  }

  /* Stats bar */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1rem 1.2rem;
    position: relative;
    overflow: hidden;
  }
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
  }
  .stat-card.blue::before { background: var(--accent); }
  .stat-card.warn::before { background: var(--warn); }
  .stat-card.danger::before { background: var(--danger); }
  .stat-card.green::before { background: var(--success); }

  .stat-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    color: var(--text3);
    text-transform: uppercase;
    margin-bottom: 0.4rem;
  }
  .stat-value {
    font-family: var(--mono);
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
  }
  .stat-card.blue .stat-value { color: var(--accent); }
  .stat-card.warn .stat-value { color: var(--warn); }
  .stat-card.danger .stat-value { color: var(--danger); }
  .stat-card.green .stat-value { color: var(--success); }
  .stat-sub {
    font-size: 0.72rem;
    color: var(--text3);
    margin-top: 0.3rem;
  }

  /* Toolbar */
  .toolbar {
    display: flex; align-items: center; gap: 0.75rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1; min-width: 200px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 0.8rem 0.5rem 2.2rem;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.82rem;
    outline: none;
    transition: border-color 0.2s;
    position: relative;
  }
  .search-wrap { position: relative; flex: 1; min-width: 200px; }
  .search-icon {
    position: absolute; left: 0.7rem; top: 50%; transform: translateY(-50%);
    color: var(--text3); font-size: 0.85rem; pointer-events: none;
  }
  .search-box:focus { border-color: var(--accent2); }
  .search-box::placeholder { color: var(--text3); }

  select.filter-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.5rem 0.8rem;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.78rem;
    outline: none;
    cursor: pointer;
  }
  select.filter-select:focus { border-color: var(--accent2); }

  .btn {
    font-family: var(--mono);
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 0.52rem 1.1rem;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .btn-primary {
    background: var(--accent);
    color: #000;
  }
  .btn-primary:hover { background: #33cfff; transform: translateY(-1px); }
  .btn-outline {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--text2);
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    font-size: 0.7rem;
    padding: 0.3rem 0.6rem;
  }
  .btn-danger:hover { background: rgba(239,68,68,0.1); }
  .btn-sm { font-size: 0.7rem; padding: 0.3rem 0.65rem; }

  /* Tabs */
  .tabs {
    display: flex; gap: 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1.5rem;
  }
  .tab {
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.65rem 1.2rem;
    cursor: pointer;
    color: var(--text3);
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
    background: none;
    border-top: none; border-left: none; border-right: none;
  }
  .tab:hover { color: var(--text2); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  /* Table */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }

  thead th {
    background: var(--surface2);
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text3);
    padding: 0.7rem 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }
  thead th:hover { color: var(--text2); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(0,196,255,0.03); }

  td {
    padding: 0.75rem 1rem;
    vertical-align: middle;
  }

  .td-name { font-weight: 500; color: var(--text); }
  .td-cat {
    font-family: var(--mono);
    font-size: 0.7rem;
    background: var(--surface2);
    padding: 0.15rem 0.5rem;
    border-radius: 2px;
    border: 1px solid var(--border);
    color: var(--text2);
    display: inline-block;
  }
  .td-mono {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--text2);
  }

  /* Status badges */
  .badge {
    font-family: var(--mono);
    font-size: 0.65rem;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.2rem 0.5rem;
    border-radius: 2px;
    display: inline-block;
  }
  .badge-ok { background: rgba(34,197,94,0.12); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
  .badge-low { background: rgba(245,158,11,0.12); color: var(--warn); border: 1px solid rgba(245,158,11,0.3); }
  .badge-critical { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
  .badge-expiring { background: rgba(245,158,11,0.12); color: var(--warn); border: 1px solid rgba(245,158,11,0.3); }
  .badge-expired { background: rgba(239,68,68,0.12); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }

  /* Qty bar */
  .qty-bar {
    display: flex; align-items: center; gap: 0.5rem;
  }
  .bar-bg {
    width: 60px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 2px;
    transition: width 0.3s;
  }
  .bar-ok { background: var(--success); }
  .bar-low { background: var(--warn); }
  .bar-critical { background: var(--danger); }

  /* Actions */
  .td-actions { display: flex; gap: 0.4rem; align-items: center; }

  /* Modal */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border2);
    border-radius: 6px;
    width: 520px;
    max-width: 95vw;
    max-height: 90vh;
    overflow-y: auto;
    transform: translateY(10px);
    transition: transform 0.2s;
  }
  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-header {
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-title {
    font-family: var(--mono);
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.08em;
  }
  .modal-close {
    background: none; border: none; color: var(--text3);
    font-size: 1.2rem; cursor: pointer; line-height: 1;
  }
  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 1.5rem; }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  .form-group { display: flex; flex-direction: column; gap: 0.4rem; }
  .form-group.full { grid-column: 1 / -1; }
  .form-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
  }
  .form-input, .form-select, .form-textarea {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 0.55rem 0.75rem;
    color: var(--text);
    font-family: var(--sans);
    font-size: 0.85rem;
    outline: none;
    transition: border-color 0.15s;
    width: 100%;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus {
    border-color: var(--accent2);
  }
  .form-textarea { resize: vertical; min-height: 80px; }
  .form-hint { font-size: 0.7rem; color: var(--text3); }

  .modal-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border);
    display: flex; justify-content: flex-end; gap: 0.75rem;
  }

  /* Alert panel */
  .alert-panel {
    background: rgba(245,158,11,0.06);
    border: 1px solid rgba(245,158,11,0.25);
    border-radius: 4px;
    padding: 1rem 1.2rem;
    margin-bottom: 1.5rem;
  }
  .alert-title {
    font-family: var(--mono);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--warn);
    margin-bottom: 0.6rem;
    display: flex; align-items: center; gap: 0.5rem;
  }
  .alert-items { display: flex; flex-direction: column; gap: 0.3rem; }
  .alert-item { font-size: 0.8rem; color: var(--text2); }
  .alert-item span { color: var(--warn); font-weight: 500; }

  /* Reports */
  .report-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }
  .report-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1.2rem;
  }
  .report-card-title {
    font-family: var(--mono);
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 1rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.7rem;
  }
  .report-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.35rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.8rem;
  }
  .report-row:last-child { border-bottom: none; }
  .report-row-label { color: var(--text2); }
  .report-row-val { font-family: var(--mono); color: var(--text); font-weight: 500; }

  /* Category chart */
  .mini-chart { margin-top: 0.5rem; }
  .chart-bar-row {
    display: flex; align-items: center; gap: 0.6rem;
    padding: 0.25rem 0;
    font-size: 0.78rem;
  }
  .chart-label { color: var(--text2); width: 110px; font-size: 0.75rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .chart-bar-bg { flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .chart-bar-inner { height: 100%; background: var(--accent); border-radius: 3px; transition: width 0.5s; }
  .chart-val { font-family: var(--mono); color: var(--text3); font-size: 0.72rem; width: 30px; text-align: right; }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text3);
    font-family: var(--mono);
    font-size: 0.82rem;
  }
  .empty-icon { font-size: 2.5rem; margin-bottom: 0.75rem; opacity: 0.4; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }

  /* Toast */
  .toast-container {
    position: fixed; bottom: 1.5rem; right: 1.5rem;
    z-index: 300; display: flex; flex-direction: column; gap: 0.5rem;
  }
  .toast {
    background: var(--surface2);
    border: 1px solid var(--border2);
    border-radius: 4px;
    padding: 0.7rem 1rem;
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--text);
    animation: slideIn 0.2s ease;
    max-width: 300px;
  }
  .toast.success { border-left: 3px solid var(--success); }
  .toast.error { border-left: 3px solid var(--danger); }
  @keyframes slideIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

  /* ‚îÄ‚îÄ Stock Movement Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .move-modal {
    width: 420px;
  }
  .move-item-name {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text);
    margin-bottom: 0.2rem;
  }
  .move-item-meta {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text3);
    margin-bottom: 1.2rem;
  }
  .move-current {
    display: flex; align-items: center; justify-content: center;
    gap: 1.5rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1rem;
    margin-bottom: 1.2rem;
    text-align: center;
  }
  .move-current-block { display: flex; flex-direction: column; gap: 0.25rem; }
  .move-current-label { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text3); }
  .move-current-val { font-family: var(--mono); font-size: 1.6rem; font-weight: 700; color: var(--text); }
  .move-current-val.par { color: var(--text3); font-size: 1.1rem; }
  .move-divider { width: 1px; height: 40px; background: var(--border); }

  /* Toggle IN / OUT */
  .move-toggle {
    display: flex;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
  }
  .move-toggle-btn {
    flex: 1;
    padding: 0.65rem;
    text-align: center;
    font-family: var(--mono);
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.1em;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--text3);
    transition: all 0.15s;
  }
  .move-toggle-btn.in.active { background: rgba(34,197,94,0.15); color: var(--success); }
  .move-toggle-btn.out.active { background: rgba(239,68,68,0.15); color: var(--danger); }
  .move-toggle-btn:not(.active):hover { color: var(--text2); }

  /* Quick amount chips */
  .move-quick {
    display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 1rem;
  }
  .move-chip {
    font-family: var(--mono);
    font-size: 0.72rem;
    padding: 0.3rem 0.65rem;
    border-radius: 3px;
    border: 1px solid var(--border2);
    background: transparent;
    color: var(--text2);
    cursor: pointer;
    transition: all 0.1s;
  }
  .move-chip:hover, .move-chip.active { border-color: var(--accent); color: var(--accent); background: rgba(0,196,255,0.07); }
  .move-chip-label {
    font-family: var(--mono);
    font-size: 0.62rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 0.4rem;
  }

  /* Amount input row */
  .move-amount-row {
    display: flex; align-items: center; gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .move-stepper {
    display: flex; align-items: center;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
    flex: 1;
  }
  .move-step-btn {
    width: 38px; height: 38px;
    background: var(--surface2);
    border: none;
    color: var(--text2);
    font-size: 1.2rem;
    cursor: pointer;
    transition: all 0.1s;
    display: flex; align-items: center; justify-content: center;
  }
  .move-step-btn:hover { background: var(--border2); color: var(--text); }
  .move-step-input {
    flex: 1;
    background: transparent;
    border: none;
    text-align: center;
    font-family: var(--mono);
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
    outline: none;
    width: 100%;
    padding: 0.4rem;
  }

  /* Preview result */
  .move-preview {
    display: flex; align-items: center; justify-content: center;
    gap: 0.8rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.7rem 1rem;
    margin-bottom: 1rem;
    font-family: var(--mono);
    font-size: 0.85rem;
    color: var(--text3);
  }
  .move-preview .old { color: var(--text2); }
  .move-preview .arrow { color: var(--text3); }
  .move-preview .newval { font-size: 1.1rem; font-weight: 700; }
  .move-preview .newval.up { color: var(--success); }
  .move-preview .newval.down { color: var(--danger); }
  .move-preview .newval.same { color: var(--text2); }

  /* Reason select */
  .move-reason-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }

  /* Transaction log */
  .txn-log {
    margin-top: 1.5rem;
    border-top: 1px solid var(--border);
    padding-top: 1.2rem;
  }
  .txn-log-title {
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text3);
    margin-bottom: 0.75rem;
  }
  .txn-list { display: flex; flex-direction: column; gap: 0.4rem; max-height: 200px; overflow-y: auto; }
  .txn-item {
    display: flex; align-items: center; gap: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    font-size: 0.78rem;
  }
  .txn-badge {
    font-family: var(--mono);
    font-size: 0.62rem;
    font-weight: 700;
    padding: 0.15rem 0.4rem;
    border-radius: 2px;
    min-width: 32px;
    text-align: center;
  }
  .txn-in { background: rgba(34,197,94,0.15); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
  .txn-out { background: rgba(239,68,68,0.15); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
  .txn-name { flex: 1; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .txn-qty { font-family: var(--mono); font-weight: 600; }
  .txn-qty.in { color: var(--success); }
  .txn-qty.out { color: var(--danger); }
  .txn-time { font-family: var(--mono); font-size: 0.65rem; color: var(--text3); white-space: nowrap; }
  .txn-reason { font-size: 0.68rem; color: var(--text3); font-style: italic; }

  /* Quick Move button in table */
  .btn-move-in {
    background: rgba(34,197,94,0.12);
    border: 1px solid rgba(34,197,94,0.3);
    color: var(--success);
    font-size: 0.68rem;
    padding: 0.28rem 0.5rem;
    border-radius: 3px;
    cursor: pointer;
    font-family: var(--mono);
    font-weight: 600;
    transition: all 0.1s;
  }
  .btn-move-in:hover { background: rgba(34,197,94,0.22); }
  .btn-move-out {
    background: rgba(239,68,68,0.12);
    border: 1px solid rgba(239,68,68,0.3);
    color: var(--danger);
    font-size: 0.68rem;
    padding: 0.28rem 0.5rem;
    border-radius: 3px;
    cursor: pointer;
    font-family: var(--mono);
    font-weight: 600;
    transition: all 0.1s;
  }
  .btn-move-out:hover { background: rgba(239,68,68,0.22); }

  /* Log tab in Reports */
  .full-log-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: auto;
    margin-top: 1rem;
  }

  /* ‚îÄ‚îÄ DB Setup Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .db-steps { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.2rem; }
  .db-step {
    display: flex; gap: 0.75rem; align-items: flex-start;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 4px; padding: 0.75rem 1rem;
  }
  .db-step-num {
    font-family: var(--mono); font-size: 0.75rem; font-weight: 700;
    color: var(--accent); min-width: 20px; padding-top: 1px;
  }
  .db-step-text { font-size: 0.8rem; color: var(--text2); line-height: 1.5; }
  .db-step-text code {
    font-family: var(--mono); font-size: 0.75rem;
    background: var(--surface2); color: var(--cold);
    padding: 0.1rem 0.35rem; border-radius: 2px;
  }
  .db-status {
    display: flex; align-items: center; gap: 0.5rem;
    font-family: var(--mono); font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    border-radius: 3px; margin-bottom: 1rem;
  }
  .db-status.connected { background: rgba(34,197,94,0.1); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
  .db-status.disconnected { background: rgba(74,101,128,0.1); color: var(--text3); border: 1px solid var(--border); }
  .db-status.error { background: rgba(239,68,68,0.1); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }

  /* ‚îÄ‚îÄ PWA Install Banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .pwa-banner {
    position: fixed; bottom: 1.5rem; left: 1.5rem;
    z-index: 400;
    background: var(--surface2);
    border: 1px solid var(--accent2);
    border-radius: 6px;
    padding: 1rem 1.2rem;
    max-width: 320px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    display: flex; flex-direction: column; gap: 0.6rem;
    animation: slideInLeft 0.3s ease;
  }
  @keyframes slideInLeft {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  .pwa-banner-title {
    font-family: var(--mono);
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.08em;
  }
  .pwa-banner-desc {
    font-size: 0.78rem;
    color: var(--text2);
    line-height: 1.4;
  }
  .pwa-banner-actions { display: flex; gap: 0.5rem; }

  /* ‚îÄ‚îÄ Sync / connection pill ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  #sync-indicator {
    display: inline-flex; align-items: center; gap: 0.3rem;
    font-family: var(--mono); font-size: 0.62rem; letter-spacing: 0.08em;
    padding: 0.18rem 0.55rem; border-radius: 20px;
    border: 1px solid var(--border); cursor: pointer;
    transition: all 0.2s; user-select: none; margin-top: 0.25rem;
  }
  #sync-indicator:hover { border-color: var(--accent2); }
  #sync-indicator.state-live    { color: var(--success); border-color: rgba(34,197,94,0.4);  background: rgba(34,197,94,0.08); }
  #sync-indicator.state-syncing { color: var(--warn);    border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.08); }
  #sync-indicator.state-local   { color: var(--text3);   border-color: var(--border);        background: transparent; }
  #sync-indicator.state-offline { color: var(--warn);    border-color: rgba(245,158,11,0.4); background: rgba(245,158,11,0.08); }
  #sync-indicator.state-error   { color: var(--danger);  border-color: rgba(239,68,68,0.4);  background: rgba(239,68,68,0.08); }

  @media (max-width: 768px) {
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .report-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .app { padding: 1rem; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-icon">‚ùÑÔ∏è</span>
    COLDCHAIN
  </div>
  <div class="header-meta">
    WAREHOUSE INVENTORY SYSTEM<br>
    <span id="clock">‚Äî</span><br>
    <span id="sync-indicator" class="state-local" onclick="openDbSetup()" title="Click to configure database">‚óã LOCAL</span>
  </div>
</header>

<!-- PWA install banner (shown when installable) -->
<div class="pwa-banner" id="pwa-banner" style="display:none">
  <div class="pwa-banner-title">üì≤ Install ColdChain</div>
  <div class="pwa-banner-desc">Add to your home screen for instant access ‚Äî works offline too.</div>
  <div class="pwa-banner-actions">
    <button class="btn btn-primary btn-sm" id="pwa-install-btn">Install App</button>
    <button class="btn btn-outline btn-sm" onclick="dismissPWA()">Not now</button>
  </div>
</div>

<div class="app">

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card blue">
      <div class="stat-label">Total SKUs</div>
      <div class="stat-value" id="stat-total">0</div>
      <div class="stat-sub">active items</div>
    </div>
    <div class="stat-card warn">
      <div class="stat-label">Low Stock</div>
      <div class="stat-value" id="stat-low">0</div>
      <div class="stat-sub">below par level</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-label">Expiring Soon</div>
      <div class="stat-value" id="stat-exp">0</div>
      <div class="stat-sub">within 7 days</div>
    </div>
    <div class="stat-card green">
      <div class="stat-label">Total Units</div>
      <div class="stat-value" id="stat-units">0</div>
      <div class="stat-sub">in warehouse</div>
    </div>
  </div>

  <!-- Alerts -->
  <div class="alert-panel" id="alert-panel" style="display:none">
    <div class="alert-title">‚ö† Active Alerts</div>
    <div class="alert-items" id="alert-items"></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="switchTab('inventory', this)">Inventory</button>
    <button class="tab" onclick="switchTab('reports', this)">Reports</button>
    <button class="tab" onclick="switchTab('log', this)">Movement Log</button>
  </div>

  <!-- Inventory Tab -->
  <div id="tab-inventory">
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" class="search-box" id="search-input" placeholder="Search products..." oninput="renderTable()">
      </div>
      <select class="filter-select" id="filter-cat" onchange="renderTable()">
        <option value="">All Categories</option>
      </select>
      <select class="filter-select" id="filter-status" onchange="renderTable()">
        <option value="">All Status</option>
        <option value="ok">In Stock</option>
        <option value="low">Low Stock</option>
        <option value="critical">Critical</option>
        <option value="expired">Expired</option>
        <option value="expiring">Expiring Soon</option>
      </select>
      <button class="btn btn-outline btn-sm" onclick="exportCSV()">‚¨á Export CSV</button>
      <button class="btn btn-primary" onclick="openModal()">+ Add Item</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('name')">Product ‚Üï</th>
            <th onclick="sortBy('category')">Category ‚Üï</th>
            <th onclick="sortBy('quantity')">Quantity ‚Üï</th>
            <th>Par Level</th>
            <th onclick="sortBy('temp')">Storage Temp</th>
            <th onclick="sortBy('expiration')">Expiration ‚Üï</th>
            <th>Status</th>
            <th>Location</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Reports Tab -->
  <div id="tab-reports" style="display:none">
    <div class="report-grid" id="report-content"></div>
  </div>

  <!-- Movement Log Tab -->
  <div id="tab-log" style="display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem;">
      <div style="font-family:var(--mono);font-size:0.8rem;color:var(--text3)">All stock movements ‚Äî <span id="log-count" style="color:var(--text2)">0</span> transactions</div>
      <button class="btn btn-outline btn-sm" onclick="clearLog()">Clear Log</button>
    </div>
    <div class="full-log-wrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Type</th>
            <th>Product</th>
            <th>Amount</th>
            <th>Before</th>
            <th>After</th>
            <th>Reason</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="log-body"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Stock Movement Modal -->
<div class="modal-overlay" id="move-overlay">
  <div class="modal move-modal">
    <div class="modal-header">
      <span class="modal-title" id="move-title">STOCK MOVEMENT</span>
      <button class="modal-close" onclick="closeMove()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="move-item-name" id="move-item-name">‚Äî</div>
      <div class="move-item-meta" id="move-item-meta">‚Äî</div>

      <!-- Current stock display -->
      <div class="move-current">
        <div class="move-current-block">
          <div class="move-current-label">Current Stock</div>
          <div class="move-current-val" id="move-cur-qty">0</div>
        </div>
        <div class="move-divider"></div>
        <div class="move-current-block">
          <div class="move-current-label">Par Level</div>
          <div class="move-current-val par" id="move-cur-par">‚Äî</div>
        </div>
        <div class="move-divider"></div>
        <div class="move-current-block">
          <div class="move-current-label">Status</div>
          <div id="move-cur-status">‚Äî</div>
        </div>
      </div>

      <!-- IN / OUT toggle -->
      <div class="move-toggle">
        <button class="move-toggle-btn in active" id="move-btn-in" onclick="setMoveDir('in')">‚ñ≤ STOCK IN</button>
        <button class="move-toggle-btn out" id="move-btn-out" onclick="setMoveDir('out')">‚ñº STOCK OUT</button>
      </div>

      <!-- Quick amount chips -->
      <div class="move-chip-label">Quick Amount</div>
      <div class="move-quick" id="move-chips">
        <button class="move-chip" onclick="setChip(1)">1</button>
        <button class="move-chip" onclick="setChip(5)">5</button>
        <button class="move-chip" onclick="setChip(10)">10</button>
        <button class="move-chip" onclick="setChip(25)">25</button>
        <button class="move-chip" onclick="setChip(50)">50</button>
        <button class="move-chip" onclick="setChip(100)">100</button>
      </div>

      <!-- Stepper -->
      <div class="move-amount-row">
        <div class="move-stepper">
          <button class="move-step-btn" onclick="stepAmount(-1)">‚àí</button>
          <input type="number" class="move-step-input" id="move-amount" value="1" min="1" oninput="updatePreview(); clearChips();">
          <button class="move-step-btn" onclick="stepAmount(1)">+</button>
        </div>
      </div>

      <!-- Preview -->
      <div class="move-preview">
        <span class="old" id="preview-old">0</span>
        <span class="arrow">‚Üí</span>
        <span class="newval" id="preview-new">0</span>
        <span id="preview-diff" style="font-size:0.72rem;color:var(--text3)"></span>
      </div>

      <!-- Reason + Note -->
      <div class="move-reason-row">
        <select class="form-select" id="move-reason" style="flex:1" onchange="updatePreview()">
          <option value="">Select reason...</option>
          <optgroup label="Stock IN">
            <option value="Delivery Received">Delivery Received</option>
            <option value="Return to Stock">Return to Stock</option>
            <option value="Inventory Adjustment">Inventory Adjustment (+)</option>
            <option value="Transfer In">Transfer In</option>
          </optgroup>
          <optgroup label="Stock OUT">
            <option value="Shipped to Customer">Shipped to Customer</option>
            <option value="Internal Use">Internal Use</option>
            <option value="Damaged / Spoiled">Damaged / Spoiled</option>
            <option value="Expired Disposal">Expired Disposal</option>
            <option value="Inventory Adjustment">Inventory Adjustment (‚àí)</option>
            <option value="Transfer Out">Transfer Out</option>
          </optgroup>
        </select>
      </div>
      <div class="form-group">
        <input type="text" class="form-input" id="move-note" placeholder="Optional note (PO#, batch, etc.)">
      </div>

      <!-- Recent transactions for this item -->
      <div class="txn-log">
        <div class="txn-log-title">Recent Movements for This Item</div>
        <div class="txn-list" id="move-txn-list"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeMove()">Cancel</button>
      <button class="btn btn-primary" id="move-confirm-btn" onclick="confirmMove()">Confirm Movement</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title" id="modal-title">ADD NEW ITEM</span>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-id">
      <div class="form-grid">
        <div class="form-group full">
          <label class="form-label">Product Name *</label>
          <input type="text" class="form-input" id="f-name" placeholder="e.g. Arctic Bay Salmon Fillets">
        </div>
        <div class="form-group">
          <label class="form-label">Category *</label>
          <select class="form-select" id="f-category">
            <option value="">Select category...</option>
            <option>Meat & Poultry</option>
            <option>Seafood</option>
            <option>Vegetables</option>
            <option>Fruits</option>
            <option>Ready Meals</option>
            <option>Dairy & Ice Cream</option>
            <option>Bakery & Dough</option>
            <option>Appetizers</option>
            <option>Soups & Broths</option>
            <option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">SKU / Product Code</label>
          <input type="text" class="form-input" id="f-sku" placeholder="e.g. SALM-001">
        </div>
        <div class="form-group">
          <label class="form-label">Quantity (units) *</label>
          <input type="number" class="form-input" id="f-quantity" min="0" placeholder="0">
        </div>
        <div class="form-group">
          <label class="form-label">Par Level (min units)</label>
          <input type="number" class="form-input" id="f-par" min="0" placeholder="e.g. 50">
          <span class="form-hint">Alert triggers below this qty</span>
        </div>
        <div class="form-group">
          <label class="form-label">Unit Weight / Size</label>
          <input type="text" class="form-input" id="f-weight" placeholder="e.g. 2 lbs, 500g">
        </div>
        <div class="form-group">
          <label class="form-label">Storage Temperature</label>
          <select class="form-select" id="f-temp">
            <option value="">Select temp...</option>
            <option value="0¬∞F / -18¬∞C">0¬∞F / -18¬∞C (Standard Frozen)</option>
            <option value="-10¬∞F / -23¬∞C">-10¬∞F / -23¬∞C (Deep Frozen)</option>
            <option value="-20¬∞F / -29¬∞C">-20¬∞F / -29¬∞C (Ultra Frozen)</option>
            <option value="32¬∞F / 0¬∞C">32¬∞F / 0¬∞C (Fresh/Chilled)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Warehouse Location</label>
          <input type="text" class="form-input" id="f-location" placeholder="e.g. Zone A, Row 3, Shelf 2">
        </div>
        <div class="form-group">
          <label class="form-label">Expiration Date</label>
          <input type="date" class="form-input" id="f-expiration">
        </div>
        <div class="form-group">
          <label class="form-label">Received Date</label>
          <input type="date" class="form-input" id="f-received">
        </div>
        <div class="form-group">
          <label class="form-label">Supplier</label>
          <input type="text" class="form-input" id="f-supplier" placeholder="Supplier name">
        </div>
        <div class="form-group">
          <label class="form-label">Cost per Unit ($)</label>
          <input type="number" class="form-input" id="f-cost" min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group full">
          <label class="form-label">Notes</label>
          <textarea class="form-textarea" id="f-notes" placeholder="Allergens, handling instructions, certifications..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save Item</button>
    </div>
  </div>
</div>

<!-- DB Setup Modal -->
<div class="modal-overlay" id="db-overlay">
  <div class="modal" style="width:560px">
    <div class="modal-header">
      <span class="modal-title">DATABASE CONNECTION</span>
      <button class="modal-close" onclick="closeDbSetup()">‚úï</button>
    </div>
    <div class="modal-body">
      <div id="db-status-bar" class="db-status disconnected">‚óã Not connected ‚Äî running in local mode</div>

      <p style="font-size:0.82rem;color:var(--text2);margin-bottom:1rem;line-height:1.6">
        Connect to <strong style="color:var(--text)">Supabase</strong> so your whole team shares the same inventory in real time.
        It takes about 5 minutes and is free.
      </p>

      <div class="db-steps">
        <div class="db-step">
          <div class="db-step-num">1</div>
          <div class="db-step-text">Go to <code>supabase.com</code> ‚Üí Sign up for a free account ‚Üí Click <strong>New Project</strong>. Name it <code>coldchain</code>.</div>
        </div>
        <div class="db-step">
          <div class="db-step-num">2</div>
          <div class="db-step-text">In your project, go to <strong>SQL Editor</strong> ‚Üí paste and run the setup SQL below to create the tables.</div>
        </div>
        <div class="db-step">
          <div class="db-step-num">3</div>
          <div class="db-step-text">Go to <strong>Project Settings ‚Üí API</strong>. Copy your <code>Project URL</code> and <code>anon public</code> key and paste them below.</div>
        </div>
      </div>

      <!-- SQL copy box -->
      <div style="margin-bottom:1.2rem">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.4rem">
          <span style="font-family:var(--mono);font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3)">Setup SQL ‚Äî paste into Supabase SQL Editor</span>
          <button class="btn btn-outline btn-sm" onclick="copySQL()">Copy SQL</button>
        </div>
        <pre id="setup-sql" style="background:var(--bg);border:1px solid var(--border);border-radius:3px;padding:0.75rem;font-family:var(--mono);font-size:0.68rem;color:var(--cold);overflow-x:auto;white-space:pre;line-height:1.5">-- Run this in Supabase SQL Editor
create table if not exists inventory (
  id text primary key,
  name text not null,
  category text,
  sku text,
  quantity integer default 0,
  par_level integer default 0,
  weight text,
  storage_temp text,
  location text,
  expiration_date date,
  received_date date,
  supplier text,
  cost_per_unit numeric(10,2) default 0,
  notes text,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table if not exists movements (
  id text primary key,
  item_id text references inventory(id) on delete set null,
  item_name text not null,
  item_sku text,
  direction text check (direction in ('in','out')),
  amount integer not null,
  qty_before integer,
  qty_after integer,
  reason text,
  note text,
  created_at timestamptz default now()
);

-- Enable realtime
alter publication supabase_realtime add table inventory;
alter publication supabase_realtime add table movements;

-- Allow public access (no login required)
alter table inventory enable row level security;
alter table movements enable row level security;
create policy "Public read" on inventory for select using (true);
create policy "Public write" on inventory for all using (true) with check (true);
create policy "Public read" on movements for select using (true);
create policy "Public write" on movements for all using (true) with check (true);</pre>
      </div>

      <!-- Credentials form -->
      <div class="form-grid" style="grid-template-columns:1fr">
        <div class="form-group">
          <label class="form-label">Supabase Project URL</label>
          <input type="text" class="form-input" id="db-url" placeholder="https://xxxxxxxxxxxx.supabase.co">
        </div>
        <div class="form-group">
          <label class="form-label">Supabase Anon Public Key</label>
          <input type="text" class="form-input" id="db-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
          <span class="form-hint">This is safe to use in the browser ‚Äî it's the public key, not the secret.</span>
        </div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:space-between">
      <button class="btn btn-danger" id="db-disconnect-btn" onclick="disconnectDB()" style="display:none">Disconnect</button>
      <div style="display:flex;gap:0.75rem">
        <button class="btn btn-outline" onclick="closeDbSetup()">Cancel</button>
        <button class="btn btn-primary" onclick="connectDB()">Connect Database</button>
      </div>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container" id="toast-container"></div>

<script>
// ‚îÄ‚îÄ Supabase CDN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Loaded dynamically so the app works offline without it
let supabase = null;

async function loadSupabaseSDK() {
  return new Promise((resolve) => {
    // Already loaded
    if (window.supabase) { resolve(true); return; }
    // Can't load external scripts from file:// ‚Äî skip silently
    if (!CC.isHTTP) { resolve(false); return; }

    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
    s.onload = () => resolve(true);
    s.onerror = () => {
      CC.warn('Supabase SDK failed to load from CDN ‚Äî check your internet connection.');
      resolve(false);
    };
    document.head.appendChild(s);
  });
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let inventory = [];
let editingId = null;
let sortKey = 'name';
let sortDir = 1;
const STORAGE_KEY = 'coldchain_inventory';
const SUPABASE_CONFIG_KEY = 'coldchain_supabase_config';
let realtimeChannel = null;
let dbMode = 'local'; // 'supabase' | 'local'

// ‚îÄ‚îÄ Supabase Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getSupabaseConfig() {
  try {
    const raw = localStorage.getItem(SUPABASE_CONFIG_KEY);
    return raw ? JSON.parse(raw) : null;
  } catch(e) { return null; }
}

function saveSupabaseConfig(url, key) {
  localStorage.setItem(SUPABASE_CONFIG_KEY, JSON.stringify({ url, key }));
}

function clearSupabaseConfig() {
  localStorage.removeItem(SUPABASE_CONFIG_KEY);
  supabase = null;
  dbMode = 'local';
}

async function initSupabase() {
  const config = getSupabaseConfig();
  if (!config?.url || !config?.key) return false;
  const loaded = await loadSupabaseSDK();
  if (!loaded) return false;
  try {
    supabase = window.supabase.createClient(config.url, config.key);
    // Quick connectivity test
    const { error } = await supabase.from('inventory').select('id').limit(1);
    if (error) throw error;
    dbMode = 'supabase';
    return true;
  } catch(e) {
    console.warn('[ColdChain] Supabase init failed:', e.message);
    supabase = null;
    dbMode = 'local';
    return false;
  }
}

// ‚îÄ‚îÄ Realtime: listen for changes from other users ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function subscribeRealtime() {
  if (!supabase || realtimeChannel) return;
  realtimeChannel = supabase
    .channel('inventory-changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'inventory' }, (payload) => {
      handleRealtimeChange('inventory', payload);
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: 'movements' }, (payload) => {
      handleRealtimeChange('movements', payload);
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        updateSyncIndicator('live');
      } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
        updateSyncIndicator('error');
      }
    });
}

function handleRealtimeChange(table, payload) {
  const { eventType, new: newRow, old: oldRow } = payload;
  if (table === 'inventory') {
    if (eventType === 'INSERT') {
      if (!inventory.find(i => i.id === newRow.id)) {
        inventory.push(dbRowToItem(newRow));
        toast(`New item added by teammate: ${newRow.name}`, 'success');
      }
    } else if (eventType === 'UPDATE') {
      const idx = inventory.findIndex(i => i.id === newRow.id);
      if (idx >= 0) inventory[idx] = dbRowToItem(newRow);
    } else if (eventType === 'DELETE') {
      inventory = inventory.filter(i => i.id !== oldRow.id);
    }
    saveLocalCache();
    updateCategoryFilter();
    renderTable();
    updateStats();
  } else if (table === 'movements') {
    if (eventType === 'INSERT') {
      if (!txnLog.find(t => t.id === newRow.id)) {
        txnLog.push(dbRowToTxn(newRow));
        saveLocalLogCache();
      }
    }
  }
}

// ‚îÄ‚îÄ Data shape converters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function itemToDbRow(item) {
  return {
    id: item.id,
    name: item.name,
    category: item.category || null,
    sku: item.sku || null,
    quantity: item.quantity || 0,
    par_level: item.par || 0,
    weight: item.weight || null,
    storage_temp: item.temp || null,
    location: item.location || null,
    expiration_date: item.expiration || null,
    received_date: item.received || null,
    supplier: item.supplier || null,
    cost_per_unit: item.cost || 0,
    notes: item.notes || null,
  };
}

function dbRowToItem(row) {
  return {
    id: row.id,
    name: row.name,
    category: row.category || '',
    sku: row.sku || '',
    quantity: row.quantity || 0,
    par: row.par_level || 0,
    weight: row.weight || '',
    temp: row.storage_temp || '',
    location: row.location || '',
    expiration: row.expiration_date || '',
    received: row.received_date || '',
    supplier: row.supplier || '',
    cost: row.cost_per_unit || 0,
    notes: row.notes || '',
  };
}

function txnToDbRow(t) {
  return {
    id: t.id,
    item_id: t.itemId,
    item_name: t.name,
    item_sku: t.sku || null,
    direction: t.dir,
    amount: t.amount,
    qty_before: t.before,
    qty_after: t.after,
    reason: t.reason || null,
    note: t.note || null,
    created_at: t.time,
  };
}

function dbRowToTxn(row) {
  return {
    id: row.id,
    itemId: row.item_id,
    name: row.item_name,
    sku: row.item_sku || '',
    dir: row.direction,
    amount: row.amount,
    before: row.qty_before,
    after: row.qty_after,
    reason: row.reason || '',
    note: row.note || '',
    time: row.created_at,
  };
}

// ‚îÄ‚îÄ Local cache (offline fallback) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocalCache() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(inventory)); } catch(e) {}
}

function saveLocalLogCache() {
  try {
    const trimmed = txnLog.slice(-500);
    localStorage.setItem('coldchain_txn_log', JSON.stringify(trimmed));
  } catch(e) {}
}

// ‚îÄ‚îÄ Load data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadData() {
  if (dbMode === 'supabase' && supabase) {
    try {
      const { data, error } = await supabase
        .from('inventory')
        .select('*')
        .order('name');
      if (error) throw error;
      inventory = data.map(dbRowToItem);
      saveLocalCache();
      // Seed demo data into Supabase if empty
      if (!inventory.length) await seedDataToSupabase();
      return;
    } catch(e) {
      console.warn('[ColdChain] Supabase load failed, using local cache:', e.message);
      updateSyncIndicator('error');
    }
  }
  // Local fallback
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) { inventory = JSON.parse(saved); return; }
  } catch(e) {}
  seedData();
}

// ‚îÄ‚îÄ Save data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveData() {
  saveLocalCache();
  // Supabase writes happen per-operation (upsert/delete), not here
}

// ‚îÄ‚îÄ Supabase CRUD operations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function dbUpsertItem(item) {
  if (dbMode !== 'supabase' || !supabase) return;
  try {
    const { error } = await supabase.from('inventory').upsert(itemToDbRow(item));
    if (error) throw error;
  } catch(e) {
    console.warn('[ColdChain] DB upsert failed:', e.message);
    toast('Saved locally ‚Äî DB sync failed', 'error');
  }
}

async function dbDeleteItem(id) {
  if (dbMode !== 'supabase' || !supabase) return;
  try {
    const { error } = await supabase.from('inventory').delete().eq('id', id);
    if (error) throw error;
  } catch(e) {
    console.warn('[ColdChain] DB delete failed:', e.message);
  }
}

async function dbInsertMovement(txn) {
  if (dbMode !== 'supabase' || !supabase) return;
  try {
    const { error } = await supabase.from('movements').insert(txnToDbRow(txn));
    if (error) throw error;
  } catch(e) {
    console.warn('[ColdChain] DB movement insert failed:', e.message);
  }
}

// ‚îÄ‚îÄ Load movement log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadLog() {
  if (dbMode === 'supabase' && supabase) {
    try {
      const { data, error } = await supabase
        .from('movements')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(500);
      if (error) throw error;
      txnLog = data.map(dbRowToTxn).reverse();
      saveLocalLogCache();
      return;
    } catch(e) {
      console.warn('[ColdChain] Supabase log load failed:', e.message);
    }
  }
  // Local fallback
  try {
    const saved = localStorage.getItem('coldchain_txn_log');
    if (saved) txnLog = JSON.parse(saved);
  } catch(e) {}
}

// ‚îÄ‚îÄ Sync indicator in header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSyncIndicator(state) {
  const el = document.getElementById('sync-indicator');
  if (!el) return;
  const states = {
    live:    { text: '‚óè LIVE',     cls: 'state-live'    },
    syncing: { text: '‚óå SYNCING',  cls: 'state-syncing' },
    local:   { text: '‚óã LOCAL',    cls: 'state-local'   },
    offline: { text: '‚ö° OFFLINE',  cls: 'state-offline' },
    error:   { text: '‚úï DB ERROR', cls: 'state-error'   },
  };
  const s = states[state] || states.local;
  el.textContent = s.text;
  el.className = s.cls;
}

// ‚îÄ‚îÄ Seed data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function seedData() {
  const today = new Date();
  const d = (days) => {
    const dt = new Date(today);
    dt.setDate(dt.getDate() + days);
    return dt.toISOString().split('T')[0];
  };
  inventory = [
    { id: uid(), name: 'Chicken Breast (Boneless)', category: 'Meat & Poultry', sku: 'CHKN-001', quantity: 240, par: 100, weight: '8 oz', temp: '0¬∞F / -18¬∞C', location: 'Zone A, Row 1', expiration: d(45), received: d(-10), supplier: 'Sunrise Farms', cost: 3.50, notes: '' },
    { id: uid(), name: 'Atlantic Salmon Fillets', category: 'Seafood', sku: 'SALM-001', quantity: 85, par: 80, weight: '6 oz', temp: '0¬∞F / -18¬∞C', location: 'Zone B, Row 2', expiration: d(5), received: d(-5), supplier: 'OceanPeak Co.', cost: 8.75, notes: 'Contains fish allergen' },
    { id: uid(), name: 'Broccoli Florets', category: 'Vegetables', sku: 'BROC-001', quantity: 420, par: 150, weight: '1 lb bag', temp: '0¬∞F / -18¬∞C', location: 'Zone C, Row 1', expiration: d(180), received: d(-3), supplier: 'GreenValley', cost: 1.20, notes: '' },
    { id: uid(), name: 'Beef Burger Patties', category: 'Meat & Poultry', sku: 'BEEF-002', quantity: 35, par: 120, weight: '4 oz', temp: '-10¬∞F / -23¬∞C', location: 'Zone A, Row 3', expiration: d(90), received: d(-15), supplier: 'RanchDirect', cost: 4.25, notes: '' },
    { id: uid(), name: 'Cheese Pizza (12")', category: 'Ready Meals', sku: 'PIZ-001', quantity: 62, par: 50, weight: '18 oz', temp: '0¬∞F / -18¬∞C', location: 'Zone D, Row 1', expiration: d(3), received: d(-20), supplier: 'PieMaster', cost: 5.00, notes: 'Contains dairy, gluten' },
    { id: uid(), name: 'Mango Chunks', category: 'Fruits', sku: 'MANGO-001', quantity: 190, par: 75, weight: '500g', temp: '0¬∞F / -18¬∞C', location: 'Zone C, Row 3', expiration: d(365), received: d(-2), supplier: 'TropiFreeze', cost: 2.10, notes: '' },
    { id: uid(), name: 'Shrimp (16/20 ct)', category: 'Seafood', sku: 'SHRMP-001', quantity: 18, par: 60, weight: '2 lb bag', temp: '-10¬∞F / -23¬∞C', location: 'Zone B, Row 1', expiration: d(60), received: d(-30), supplier: 'OceanPeak Co.', cost: 12.00, notes: 'Contains shellfish allergen' },
    { id: uid(), name: 'Vanilla Ice Cream (1 gal)', category: 'Dairy & Ice Cream', sku: 'ICE-001', quantity: 0, par: 24, weight: '1 gallon', temp: '-20¬∞F / -29¬∞C', location: 'Zone E, Row 2', expiration: d(-2), received: d(-60), supplier: 'CreamDream', cost: 6.50, notes: '' },
  ];
  saveLocalCache();
}

async function seedDataToSupabase() {
  seedData(); // populate inventory array with defaults
  try {
    const { error } = await supabase.from('inventory').insert(inventory.map(itemToDbRow));
    if (error) throw error;
    toast('Sample data loaded into database', 'success');
  } catch(e) {
    console.warn('[ColdChain] Seed to Supabase failed:', e.message);
  }
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getStatus(item) {
  const today = new Date();
  if (item.expiration) {
    const exp = new Date(item.expiration);
    const diff = Math.ceil((exp - today) / 86400000);
    if (diff < 0) return 'expired';
    if (diff <= 7) return 'expiring';
  }
  if (!item.par) return item.quantity > 0 ? 'ok' : 'critical';
  const ratio = item.quantity / item.par;
  if (ratio === 0) return 'critical';
  if (ratio < 0.5) return 'critical';
  if (ratio < 1) return 'low';
  return 'ok';
}

function statusBadge(s) {
  const map = {
    ok: ['badge-ok', 'IN STOCK'],
    low: ['badge-low', 'LOW STOCK'],
    critical: ['badge-critical', 'CRITICAL'],
    expiring: ['badge-expiring', 'EXPIRING'],
    expired: ['badge-expired', 'EXPIRED'],
  };
  const [cls, label] = map[s] || map.ok;
  return `<span class="badge ${cls}">${label}</span>`;
}

function daysUntil(dateStr) {
  if (!dateStr) return null;
  const diff = Math.ceil((new Date(dateStr) - new Date()) / 86400000);
  return diff;
}

function fmtDate(dateStr) {
  if (!dateStr) return '‚Äî';
  const d = new Date(dateStr + 'T00:00:00');
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
  document.getElementById('stat-total').textContent = inventory.length;
  const low = inventory.filter(i => { const s=getStatus(i); return s==='low'||s==='critical'; }).length;
  const exp = inventory.filter(i => { const s=getStatus(i); return s==='expiring'||s==='expired'; }).length;
  const units = inventory.reduce((a,i) => a + (i.quantity||0), 0);
  document.getElementById('stat-low').textContent = low;
  document.getElementById('stat-exp').textContent = exp;
  document.getElementById('stat-units').textContent = units.toLocaleString();

  // Alerts
  const alerts = inventory.filter(i => getStatus(i) !== 'ok');
  const panel = document.getElementById('alert-panel');
  const list = document.getElementById('alert-items');
  if (alerts.length) {
    panel.style.display = '';
    list.innerHTML = alerts.slice(0,6).map(i => {
      const s = getStatus(i);
      const msgs = {
        low: `<span>${i.name}</span> ‚Äî qty ${i.quantity} is below par level of ${i.par}`,
        critical: `<span>${i.name}</span> ‚Äî critically low (${i.quantity} units)`,
        expiring: `<span>${i.name}</span> ‚Äî expires ${fmtDate(i.expiration)} (${daysUntil(i.expiration)}d)`,
        expired: `<span>${i.name}</span> ‚Äî EXPIRED on ${fmtDate(i.expiration)}`,
      };
      return `<div class="alert-item">‚ö° ${msgs[s]||''}</div>`;
    }).join('');
  } else {
    panel.style.display = 'none';
  }
}

// ‚îÄ‚îÄ Category filter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCategoryFilter() {
  const sel = document.getElementById('filter-cat');
  const current = sel.value;
  const cats = [...new Set(inventory.map(i => i.category).filter(Boolean))].sort();
  sel.innerHTML = `<option value="">All Categories</option>` + cats.map(c => `<option ${c===current?'selected':''}>${c}</option>`).join('');
}

// ‚îÄ‚îÄ Table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sortBy(key) {
  if (sortKey === key) sortDir *= -1;
  else { sortKey = key; sortDir = 1; }
  renderTable();
}

function renderTable() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const catFilter = document.getElementById('filter-cat').value;
  const statusFilter = document.getElementById('filter-status').value;

  let items = [...inventory];
  if (search) items = items.filter(i =>
    i.name?.toLowerCase().includes(search) ||
    i.sku?.toLowerCase().includes(search) ||
    i.supplier?.toLowerCase().includes(search) ||
    i.location?.toLowerCase().includes(search)
  );
  if (catFilter) items = items.filter(i => i.category === catFilter);
  if (statusFilter) items = items.filter(i => getStatus(i) === statusFilter);

  items.sort((a,b) => {
    let va = a[sortKey]||'', vb = b[sortKey]||'';
    if (typeof va === 'number') return (va-vb)*sortDir;
    return String(va).localeCompare(String(vb)) * sortDir;
  });

  const tbody = document.getElementById('table-body');
  if (!items.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">üì¶</div>No items found.</div></td></tr>`;
    return;
  }

  tbody.innerHTML = items.map(item => {
    const s = getStatus(item);
    const ratio = item.par ? Math.min(item.quantity / item.par, 1) : 1;
    const barClass = s === 'critical' ? 'bar-critical' : s === 'low' ? 'bar-low' : 'bar-ok';
    const days = daysUntil(item.expiration);
    const expColor = days !== null ? (days < 0 ? 'color:var(--danger)' : days <= 7 ? 'color:var(--warn)' : '') : '';

    return `<tr>
      <td>
        <div class="td-name">${item.name}</div>
        ${item.sku ? `<div style="font-family:var(--mono);font-size:0.68rem;color:var(--text3);margin-top:2px">${item.sku}</div>` : ''}
      </td>
      <td><span class="td-cat">${item.category||'‚Äî'}</span></td>
      <td>
        <div class="qty-bar">
          <div class="bar-bg"><div class="bar-fill ${barClass}" style="width:${Math.round(ratio*100)}%"></div></div>
          <span class="td-mono">${(item.quantity||0).toLocaleString()}</span>
        </div>
      </td>
      <td class="td-mono" style="color:var(--text3)">${item.par || '‚Äî'}</td>
      <td class="td-mono" style="font-size:0.72rem;color:var(--text3)">${item.temp||'‚Äî'}</td>
      <td class="td-mono" style="font-size:0.78rem;${expColor}">${fmtDate(item.expiration)}${days !== null ? `<div style="font-size:0.65rem;opacity:0.7">${days >= 0 ? days+'d left' : 'expired'}</div>` : ''}</td>
      <td>${statusBadge(s)}</td>
      <td style="font-size:0.75rem;color:var(--text3)">${item.location||'‚Äî'}</td>
      <td>
        <div class="td-actions">
          <button class="btn-move-in" onclick="openMove('${item.id}','in')">‚ñ≤ IN</button>
          <button class="btn-move-out" onclick="openMove('${item.id}','out')">‚ñº OUT</button>
          <button class="btn btn-outline btn-sm" onclick="editItem('${item.id}')">Edit</button>
          <button class="btn btn-danger" onclick="deleteItem('${item.id}')">‚úï</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ Reports ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderReports() {
  const catCounts = {};
  const catUnits = {};
  inventory.forEach(i => {
    catCounts[i.category] = (catCounts[i.category]||0) + 1;
    catUnits[i.category] = (catUnits[i.category]||0) + (i.quantity||0);
  });

  const topCats = Object.entries(catUnits).sort((a,b) => b[1]-a[1]);
  const maxUnits = topCats[0]?.[1] || 1;

  const totalValue = inventory.reduce((a,i) => a + ((i.cost||0)*(i.quantity||0)), 0);
  const expired = inventory.filter(i => getStatus(i) === 'expired');
  const expiring = inventory.filter(i => getStatus(i) === 'expiring');
  const lowItems = inventory.filter(i => { const s=getStatus(i); return s==='low'||s==='critical'; });

  document.getElementById('report-content').innerHTML = `
    <div class="report-card">
      <div class="report-card-title">üìä Inventory Summary</div>
      ${[
        ['Total SKUs', inventory.length],
        ['Total Units', inventory.reduce((a,i) => a+(i.quantity||0),0).toLocaleString()],
        ['Total Est. Value', '$'+totalValue.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})],
        ['Avg. Qty per SKU', inventory.length ? Math.round(inventory.reduce((a,i)=>a+(i.quantity||0),0)/inventory.length) : 0],
        ['Items Below Par', lowItems.length],
        ['Expired Items', expired.length],
        ['Expiring (7d)', expiring.length],
      ].map(([l,v]) => `<div class="report-row"><span class="report-row-label">${l}</span><span class="report-row-val">${v}</span></div>`).join('')}
    </div>

    <div class="report-card">
      <div class="report-card-title">üè∑ Units by Category</div>
      <div class="mini-chart">
        ${topCats.map(([cat,units]) => `
          <div class="chart-bar-row">
            <span class="chart-label">${cat}</span>
            <div class="chart-bar-bg"><div class="chart-bar-inner" style="width:${Math.round(units/maxUnits*100)}%"></div></div>
            <span class="chart-val">${units}</span>
          </div>`).join('')}
        ${!topCats.length ? '<div style="color:var(--text3);font-size:0.8rem">No data</div>' : ''}
      </div>
    </div>

    <div class="report-card">
      <div class="report-card-title">‚ö† Expiration Watch</div>
      ${[...expiring, ...expired].slice(0,8).map(i => {
        const days = daysUntil(i.expiration);
        const s = getStatus(i);
        return `<div class="report-row">
          <span class="report-row-label">${i.name}</span>
          <span class="report-row-val" style="color:${s==='expired'?'var(--danger)':'var(--warn)'}">
            ${days < 0 ? 'EXP' : days+'d'}
          </span>
        </div>`;
      }).join('') || '<div style="color:var(--success);font-size:0.8rem;padding:0.5rem 0">‚úì No expiring items</div>'}
    </div>
  `;
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id=null) {
  editingId = id;
  document.getElementById('modal-title').textContent = id ? 'EDIT ITEM' : 'ADD NEW ITEM';
  const fields = ['name','category','sku','quantity','par','weight','temp','location','expiration','received','supplier','cost','notes'];
  fields.forEach(f => document.getElementById('f-'+f).value = '');

  if (id) {
    const item = inventory.find(i => i.id === id);
    if (item) fields.forEach(f => { if (item[f] !== undefined) document.getElementById('f-'+f).value = item[f]; });
  }
  document.getElementById('modal-overlay').classList.add('open');
}
function editItem(id) { openModal(id); }
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); editingId = null; }

async function saveItem() {
  const name = document.getElementById('f-name').value.trim();
  const qty = parseInt(document.getElementById('f-quantity').value);
  if (!name) { toast('Product name is required', 'error'); return; }
  if (isNaN(qty) || qty < 0) { toast('Enter a valid quantity', 'error'); return; }

  const item = {
    id: editingId || uid(),
    name,
    category: document.getElementById('f-category').value,
    sku: document.getElementById('f-sku').value.trim(),
    quantity: qty,
    par: parseInt(document.getElementById('f-par').value) || 0,
    weight: document.getElementById('f-weight').value.trim(),
    temp: document.getElementById('f-temp').value,
    location: document.getElementById('f-location').value.trim(),
    expiration: document.getElementById('f-expiration').value,
    received: document.getElementById('f-received').value,
    supplier: document.getElementById('f-supplier').value.trim(),
    cost: parseFloat(document.getElementById('f-cost').value) || 0,
    notes: document.getElementById('f-notes').value.trim(),
  };

  if (editingId) {
    const idx = inventory.findIndex(i => i.id === editingId);
    if (idx >= 0) inventory[idx] = item;
    toast('Item updated successfully', 'success');
  } else {
    inventory.push(item);
    toast('Item added to inventory', 'success');
  }

  saveLocalCache();
  await dbUpsertItem(item);
  closeModal();
  updateCategoryFilter();
  renderTable();
  updateStats();
}

function deleteItem(id) {
  if (!confirm('Remove this item from inventory?')) return;
  inventory = inventory.filter(i => i.id !== id);
  saveLocalCache();
  dbDeleteItem(id);
  updateCategoryFilter();
  renderTable();
  updateStats();
  toast('Item removed', 'success');
}

// ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  const headers = ['Name','SKU','Category','Quantity','Par Level','Status','Temp','Location','Expiration','Received','Supplier','Cost','Notes'];
  const rows = inventory.map(i => [
    i.name, i.sku, i.category, i.quantity, i.par, getStatus(i), i.temp, i.location, i.expiration, i.received, i.supplier, i.cost, i.notes
  ].map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
  a.download = `coldchain_inventory_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  toast('CSV exported', 'success');
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// ‚îÄ‚îÄ Clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleString('en-US', {
    weekday:'short', month:'short', day:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
}

// ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  document.getElementById('tab-inventory').style.display = tab === 'inventory' ? '' : 'none';
  document.getElementById('tab-reports').style.display = tab === 'reports' ? '' : 'none';
  document.getElementById('tab-log').style.display = tab === 'log' ? '' : 'none';
  if (tab === 'reports') renderReports();
  if (tab === 'log') renderLog();
}

// ‚îÄ‚îÄ Movement Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let txnLog = [];

async function saveLog() {
  saveLocalLogCache();
}

function renderLog() {
  const body = document.getElementById('log-body');
  document.getElementById('log-count').textContent = txnLog.length;
  if (!txnLog.length) {
    body.innerHTML = `<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">üìã</div>No movements recorded yet.</div></td></tr>`;
    return;
  }
  const sorted = [...txnLog].reverse();
  body.innerHTML = sorted.map(t => `
    <tr>
      <td class="td-mono" style="font-size:0.7rem;white-space:nowrap;color:var(--text3)">${fmtDateTime(t.time)}</td>
      <td><span class="txn-badge txn-${t.dir}">${t.dir.toUpperCase()}</span></td>
      <td>
        <div style="font-weight:500;font-size:0.82rem">${t.name}</div>
        ${t.sku ? `<div style="font-family:var(--mono);font-size:0.65rem;color:var(--text3)">${t.sku}</div>` : ''}
      </td>
      <td class="td-mono txn-qty ${t.dir}" style="font-size:0.9rem">${t.dir==='in'?'+':'‚àí'}${t.amount}</td>
      <td class="td-mono" style="color:var(--text3)">${t.before}</td>
      <td class="td-mono" style="color:var(--text2);font-weight:600">${t.after}</td>
      <td style="font-size:0.75rem;color:var(--text3)">${t.reason||'‚Äî'}</td>
      <td style="font-size:0.75rem;color:var(--text3);font-style:italic">${t.note||'‚Äî'}</td>
    </tr>`).join('');
}

function fmtDateTime(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' ' +
    d.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
}

function clearLog() {
  if (!confirm('Clear all movement history? This cannot be undone.')) return;
  txnLog = [];
  saveLog();
  renderLog();
  toast('Movement log cleared', 'success');
}

// ‚îÄ‚îÄ Stock Move Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let moveItemId = null;
let moveDir = 'in';

function openMove(id, dir='in') {
  moveItemId = id;
  const item = inventory.find(i => i.id === id);
  if (!item) return;
  document.getElementById('move-item-name').textContent = item.name;
  document.getElementById('move-item-meta').textContent = [item.sku, item.category, item.location].filter(Boolean).join(' ¬∑ ');
  document.getElementById('move-cur-qty').textContent = (item.quantity||0).toLocaleString();
  document.getElementById('move-cur-par').textContent = item.par || '‚Äî';
  document.getElementById('move-cur-status').innerHTML = statusBadge(getStatus(item));
  document.getElementById('move-amount').value = 1;
  document.getElementById('move-reason').value = '';
  document.getElementById('move-note').value = '';
  clearChips();
  setMoveDir(dir);
  // Recent transactions for this item
  const itemTxns = txnLog.filter(t => t.itemId === id).slice(-5).reverse();
  const txnList = document.getElementById('move-txn-list');
  if (itemTxns.length) {
    txnList.innerHTML = itemTxns.map(t => `
      <div class="txn-item">
        <span class="txn-badge txn-${t.dir}">${t.dir.toUpperCase()}</span>
        <span class="txn-qty ${t.dir}">${t.dir==='in'?'+':'‚àí'}${t.amount}</span>
        <span class="txn-name">${t.reason||'No reason'}</span>
        <span class="txn-time">${fmtDateTime(t.time)}</span>
      </div>`).join('');
  } else {
    txnList.innerHTML = `<div style="color:var(--text3);font-size:0.78rem;padding:0.3rem 0">No movements yet for this item.</div>`;
  }
  document.getElementById('move-overlay').classList.add('open');
  updatePreview();
}

function closeMove() {
  document.getElementById('move-overlay').classList.remove('open');
  moveItemId = null;
}

function setMoveDir(dir) {
  moveDir = dir;
  document.getElementById('move-btn-in').classList.toggle('active', dir==='in');
  document.getElementById('move-btn-out').classList.toggle('active', dir==='out');
  const btn = document.getElementById('move-confirm-btn');
  btn.style.background = dir==='in' ? 'var(--success)' : 'var(--danger)';
  btn.style.color = '#fff';
  updatePreview();
}

function setChip(val) {
  document.getElementById('move-amount').value = val;
  document.querySelectorAll('.move-chip').forEach(c => c.classList.toggle('active', parseInt(c.textContent)===val));
  updatePreview();
}

function clearChips() {
  document.querySelectorAll('.move-chip').forEach(c => c.classList.remove('active'));
}

function stepAmount(delta) {
  const inp = document.getElementById('move-amount');
  const cur = parseInt(inp.value)||0;
  inp.value = Math.max(1, cur+delta);
  clearChips();
  updatePreview();
}

function updatePreview() {
  const item = inventory.find(i => i.id === moveItemId);
  if (!item) return;
  const amount = Math.max(0, parseInt(document.getElementById('move-amount').value)||0);
  const before = item.quantity || 0;
  const after = moveDir==='in' ? before+amount : Math.max(0, before-amount);
  document.getElementById('preview-old').textContent = before;
  const newEl = document.getElementById('preview-new');
  newEl.textContent = after;
  newEl.className = 'newval ' + (after > before ? 'up' : after < before ? 'down' : 'same');
  const diff = after - before;
  document.getElementById('preview-diff').textContent = diff !== 0 ? `(${diff>0?'+':''}${diff})` : '';
}

async function confirmMove() {
  const item = inventory.find(i => i.id === moveItemId);
  if (!item) return;
  const amount = parseInt(document.getElementById('move-amount').value)||0;
  if (amount <= 0) { toast('Enter a valid amount', 'error'); return; }
  const reason = document.getElementById('move-reason').value;
  const note = document.getElementById('move-note').value.trim();
  const before = item.quantity || 0;
  const after = moveDir==='in' ? before+amount : Math.max(0, before-amount);

  // Record transaction
  const txn = {
    id: uid(),
    itemId: item.id,
    name: item.name,
    sku: item.sku || '',
    dir: moveDir,
    amount,
    before,
    after,
    reason,
    note,
    time: new Date().toISOString(),
  };
  txnLog.push(txn);

  // Update inventory quantity
  const idx = inventory.findIndex(i => i.id === moveItemId);
  inventory[idx].quantity = after;

  saveLocalCache();
  saveLocalLogCache();

  // Write to Supabase
  await dbUpsertItem(inventory[idx]);
  await dbInsertMovement(txn);
  closeMove();
  updateCategoryFilter();
  renderTable();
  updateStats();

  const verb = moveDir==='in' ? `+${amount} added` : `‚àí${amount} removed`;
  toast(`${verb} ‚Üí ${item.name} now at ${after}`, moveDir==='in' ? 'success' : 'success');
}

// ‚îÄ‚îÄ DB Setup Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDbSetup() {
  const config = getSupabaseConfig();
  if (config) {
    document.getElementById('db-url').value = config.url || '';
    document.getElementById('db-key').value = config.key || '';
  }
  const statusBar = document.getElementById('db-status-bar');
  const disconnectBtn = document.getElementById('db-disconnect-btn');
  if (dbMode === 'supabase') {
    statusBar.className = 'db-status connected';
    statusBar.textContent = '‚óè Connected to Supabase ‚Äî real-time sync active';
    disconnectBtn.style.display = '';
  } else {
    statusBar.className = 'db-status disconnected';
    statusBar.textContent = '‚óã Not connected ‚Äî running in local mode';
    disconnectBtn.style.display = 'none';
  }
  document.getElementById('db-overlay').classList.add('open');
}

function closeDbSetup() {
  document.getElementById('db-overlay').classList.remove('open');
}

async function connectDB() {
  const url = document.getElementById('db-url').value.trim();
  const key = document.getElementById('db-key').value.trim();
  if (!url || !key) { toast('Enter both URL and key', 'error'); return; }
  if (!url.startsWith('https://')) { toast('URL must start with https://', 'error'); return; }

  toast('Connecting to database...', 'success');
  saveSupabaseConfig(url, key);

  const ok = await initSupabase();
  if (ok) {
    closeDbSetup();
    toast('Connected! Loading shared inventory...', 'success');
    await loadData();
    await loadLog();
    updateCategoryFilter();
    renderTable();
    updateStats();
    subscribeRealtime();
    updateSyncIndicator('live');
  } else {
    document.getElementById('db-status-bar').className = 'db-status error';
    document.getElementById('db-status-bar').textContent = '‚úï Connection failed ‚Äî check your URL and key';
    clearSupabaseConfig();
    toast('Connection failed ‚Äî check your credentials', 'error');
  }
}

async function disconnectDB() {
  if (!confirm('Disconnect from Supabase? The app will use local data only.')) return;
  if (realtimeChannel) { supabase.removeChannel(realtimeChannel); realtimeChannel = null; }
  clearSupabaseConfig();
  dbMode = 'local';
  closeDbSetup();
  updateSyncIndicator('local');
  toast('Disconnected ‚Äî using local mode', 'success');
}

function copySQL() {
  const sql = document.getElementById('setup-sql').textContent;
  navigator.clipboard.writeText(sql).then(() => toast('SQL copied to clipboard', 'success'));
}

document.getElementById('db-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeDbSetup();
});

// ‚îÄ‚îÄ ColdChain Diagnostics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// All startup messages are grouped so the console stays clean.
// Only real runtime errors will appear outside this group.
const CC = {
  isHTTP: location.protocol === 'https:' || location.protocol === 'http:',
  isSecure: location.protocol === 'https:',

  log(msg, ...args)  { console.log(`%c[ColdChain] ${msg}`, 'color:#00c4ff', ...args); },
  warn(msg, ...args) { console.warn(`[ColdChain] ${msg}`, ...args); },
  err(msg, ...args)  { console.error(`[ColdChain] ${msg}`, ...args); },

  group(label) { console.groupCollapsed(`%c‚ùÑ ColdChain ‚Äî ${label}`, 'color:#00c4ff;font-weight:bold'); },
  groupEnd()   { console.groupEnd(); },
};

// ‚îÄ‚îÄ PWA: inject manifest only when served over HTTP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Prevents the "manifest.json 404" console error when opening as a local file.
if (CC.isHTTP) {
  const manifest = document.createElement('link');
  manifest.rel = 'manifest';
  manifest.href = 'manifest.json';
  // Silence the 404 if manifest.json hasn't been uploaded yet
  manifest.onerror = () => CC.warn('manifest.json not found ‚Äî PWA install unavailable. Upload manifest.json to enable.');
  document.head.appendChild(manifest);

  const icon = document.createElement('link');
  icon.rel = 'apple-touch-icon';
  icon.href = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' fill='%230a0e14'/%3E%3Ctext x='96' y='130' font-size='100' text-anchor='middle'%3E%E2%9D%84%EF%B8%8F%3C/text%3E%3C/svg%3E";
  document.head.appendChild(icon);
}

// ‚îÄ‚îÄ PWA: Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let swRegistration = null;

async function registerServiceWorker() {
  // Guard 1: API must exist
  if (!('serviceWorker' in navigator)) {
    CC.log('Service Worker not supported in this browser ‚Äî skipping.');
    return;
  }
  // Guard 2: must be served over HTTP/HTTPS (not file://)
  if (!CC.isHTTP) {
    CC.log('Service Worker requires HTTP/HTTPS. Open via Vercel URL to enable offline mode.');
    return;
  }
  // Guard 3: HTTPS required for SW in production (HTTP ok for localhost)
  if (!CC.isSecure && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
    CC.warn('Service Worker requires HTTPS in production. Deploy to Vercel to enable.');
    return;
  }

  try {
    swRegistration = await navigator.serviceWorker.register('service-worker.js');
    CC.log('Service Worker registered. Scope:', swRegistration.scope);

    swRegistration.addEventListener('updatefound', () => {
      const newWorker = swRegistration.installing;
      if (!newWorker) return;
      newWorker.addEventListener('statechange', () => {
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          toast('App update available ‚Äî refresh to apply', 'success');
        }
      });
    });
  } catch (err) {
    // service-worker.js not found is expected when running standalone HTML
    if (err.name === 'TypeError' || err.message?.includes('404') || err.message?.includes('Failed to register')) {
      CC.warn('service-worker.js not found ‚Äî upload it alongside the HTML to enable offline mode.');
    } else {
      CC.warn('Service Worker registration failed:', err.message);
    }
  }
}

// ‚îÄ‚îÄ PWA: Install prompt ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  if (!localStorage.getItem('pwa-dismissed')) {
    document.getElementById('pwa-banner').style.display = '';
  }
});

window.addEventListener('appinstalled', () => {
  document.getElementById('pwa-banner').style.display = 'none';
  deferredInstallPrompt = null;
  toast('ColdChain installed successfully!', 'success');
});

const pwaBtn = document.getElementById('pwa-install-btn');
if (pwaBtn) {
  pwaBtn.addEventListener('click', async () => {
    if (!deferredInstallPrompt) return;
    deferredInstallPrompt.prompt();
    const { outcome } = await deferredInstallPrompt.userChoice;
    if (outcome === 'accepted') {
      document.getElementById('pwa-banner').style.display = 'none';
    }
    deferredInstallPrompt = null;
  });
}

function dismissPWA() {
  const banner = document.getElementById('pwa-banner');
  if (banner) banner.style.display = 'none';
  localStorage.setItem('pwa-dismissed', '1');
}

// ‚îÄ‚îÄ Network status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateOnlineStatus() {
  if (!navigator.onLine) {
    if (dbMode === 'supabase') updateSyncIndicator('offline');
  } else {
    if (dbMode === 'supabase') updateSyncIndicator('live');
    else updateSyncIndicator('local');
  }
}

window.addEventListener('online', () => {
  updateOnlineStatus();
  if (dbMode === 'supabase') toast('Back online ‚Äî syncing with database', 'success');
});
window.addEventListener('offline', () => {
  updateOnlineStatus();
  toast('Gone offline ‚Äî changes saved locally on this device', 'error');
});

// ‚îÄ‚îÄ Global error boundary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Catches unhandled promise rejections and runtime errors so they surface
// clearly rather than as cryptic browser messages.
window.addEventListener('unhandledrejection', e => {
  // Suppress known non-critical rejections
  const msg = e.reason?.message || String(e.reason);
  const suppress = [
    'Load failed',           // font/CDN fetch when offline
    'Failed to fetch',       // same
    'NetworkError',          // same
    'net::ERR_',             // Chrome network errors
    'The operation was aborted', // AbortController cancels
  ];
  if (suppress.some(s => msg.includes(s))) {
    e.preventDefault(); // don't log to console
    return;
  }
  CC.err('Unhandled error:', msg);
});

window.addEventListener('error', e => {
  // Suppress font/CDN resource load errors ‚Äî these are non-fatal
  if (e.target && (e.target.tagName === 'LINK' || e.target.tagName === 'SCRIPT')) {
    const src = e.target.href || e.target.src || '';
    if (src.includes('fonts.googleapis') || src.includes('fonts.gstatic') || src.includes('jsdelivr')) {
      CC.warn(`External resource failed to load (non-fatal): ${src}`);
      e.preventDefault();
      return;
    }
  }
}, true); // capture phase to catch resource errors

// ‚îÄ‚îÄ Modal outside click ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('modal-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeModal();
});
document.getElementById('move-overlay').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeMove();
});

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function init() {
  CC.group('Startup');
  CC.log('Version: 1.0 | Mode:', CC.isHTTP ? 'HTTP' : 'Local file');

  // Inject manifest / SW only when context supports it
  if (!CC.isHTTP) {
    CC.log('Running as local file ‚Äî Supabase, SW, and PWA features require HTTP. Use Vercel to deploy.');
  }

  // Supabase connection
  const config = getSupabaseConfig();
  if (config?.url && config?.key) {
    CC.log('Saved Supabase config found ‚Äî attempting connection...');
    updateSyncIndicator('syncing');
    const ok = await initSupabase();
    if (ok) {
      CC.log('Supabase connected successfully.');
    } else {
      CC.warn('Supabase connection failed ‚Äî falling back to local storage.');
      updateSyncIndicator('error');
    }
  } else {
    CC.log('No Supabase config ‚Äî running in local mode. Click the sync pill to connect.');
    updateSyncIndicator('local');
  }

  // Load data
  await loadData();
  await loadLog();
  CC.log(`Loaded ${inventory.length} inventory items, ${txnLog.length} movement records.`);

  // Render
  updateCategoryFilter();
  renderTable();
  updateStats();
  updateClock();
  updateOnlineStatus();
  setInterval(updateClock, 1000);

  // PWA / Service Worker
  registerServiceWorker(); // handles all its own guards internally

  // Realtime subscription
  if (dbMode === 'supabase') {
    subscribeRealtime();
    updateSyncIndicator('live');
    CC.log('Realtime subscription active.');
  }

  CC.groupEnd();
})();
</script>
</body>
</html>
